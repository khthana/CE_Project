Unit    GA1 ;
interface

Const    MaxLength = 80 ;
         MaxChrom  = 50 ;
Type
         ChromType   = array[1..MaxLength] of char ;
         CrossType   = (OnePoint,TwoPoint) ;
         SelectType  = (Tournament,Roulette) ;
         String20    = String[20] ;
         PhenoType   = Record
                             W1 : integer ;
                             W2 : integer ;
                             W3 : integer ;
                             W4 : integer ;
                             W5 : integer ;
                             W6 : integer ;
                             W7 : integer ;
                             W8 : integer ;
                       end ;

         TChromosome = object
                         Genotype  : ChromType ;
                         Lchrom    : integer   ;
                         Evaluate  : real      ;
                         Fitness   : real      ;
                         Number    : integer   ;
                         Gen       : integer   ;
                         Pheno     : PhenoType ;


                         Procedure DisPlay ;
                         Procedure Init ;
                         Procedure AddFitness(FValue  : real) ;
                         Procedure AddEvaluate(EValue : real) ;
                         Procedure GetPhenoType(NumBit : integer) ;
                         Procedure AddChrom(var Phenome : ChromType) ;
                       end ;

         TChromList  = object
                         NumChrom  :  integer ;
                         ChromList :  array[1..MaxChrom] of TChromosome ;

                         Procedure Init ;
                         Procedure DisPlay ;
                       end ;

         TPopulation = object
                         PCross      : real    ;
                         PMute       : real    ;
                         PopSize     : integer ;
                         Generation  : integer ;
                         ChromNumber : integer ;
                         Population  : TChromList ;
                         Crosstype   : CrossType  ;
                         Selecttype  : SelectType ;
                         InvertOptr  : boolean ;
                         SumFitness  : real ;
                         Average     : real ;
                         MaxChrom    : TChromosome ;
                         MinChrom    : TChromosome ;

                         Procedure Init ;
                         Procedure Selection   ;
                         Procedure CrossOver   ;
                         Procedure Mutation    ;
                         {Procedure CreateNextGen ;}
                         Procedure DisPlay     ;
                         Procedure UpdateGen   ;
                         Procedure CalSumFitness ;
                         Procedure CalFitNess(ChromNum  : integer) ;
                         Procedure SetFitNess(ChromNum  : integer ; fit : real) ;
                         Function  GetFitNess(ChromNum  : integer) : real ;
                         Procedure CalEvaluate(ChromNum : integer) ;
                         {Procedure WriteToFile ;}
                         Procedure FindMaxMin ;
                       end ;


                       Procedure Cross(var Par1,Par2,Chld1,Chld2 : TChromosome ;
                                           Pc : real) ;
                       Procedure Mutate(var Chrom1,Chrom2 : TChromosome ; Pm : real) ;

implementation
const NumBit = 5 ;
var Spool : TChromList ;

Function Bi2Dec(var BinStrg : String20 ; NumBit : integer) : integer ;
var Num,i,Len : integer ;
begin
     Num := 0 ;
     Len := NumBit-1 {Length(BinStrg)} ;
     for i := 0 to Len do
         begin
              if BinStrg[Len-i]='1' then Num := Num+trunc(exp(i*ln(2))) ;
         end ;
     Bi2Dec := Num ;
end ;

Procedure TChromosome.GetPhenoType(NumBit : integer) ;
var Temp : array[1..8] of String20 ;
    T    : String20 ;
    i,j,k : integer ;
begin
     j := 1 ;
     k := 1 ;

     for i := 1 to LChrom do
         begin
              T[j] := GenoType[i] ;
              if (i mod Numbit) = 0 then
                 begin
                      Temp[k] := T ;
                      k := k+1 ;
                      j := 0   ;
                 end ;
              j := j+1 ;
         end ;
     Pheno.W1 := Bi2Dec(Temp[1],NumBit) ;
     Pheno.W2 := Bi2Dec(Temp[2],NumBit) ;
     Pheno.W3 := Bi2Dec(Temp[3],NumBit) ;
     Pheno.W4 := Bi2Dec(Temp[4],NumBit) ;
     Pheno.W5 := Bi2Dec(Temp[5],NumBit) ;
     Pheno.W6 := Bi2Dec(Temp[6],NumBit) ;
     Pheno.W7 := Bi2Dec(Temp[7],NumBit) ;
     Pheno.W8 := Bi2Dec(Temp[8],NumBit) ;

end ;


Procedure TChromosome.DisPlay ;
var  i,Num : integer ;
begin
     Num := LChrom ;

{     Write('Parent1  = ') ;
     for i := 1 to Num do
         begin
              write(Phenotype[i]) ;
         end ;
     writeln ;

     Write('Parent2  = ') ;
     for i := 1 to Num do
         begin
              write(Phenotype[i]) ;
         end ;
     writeln ;
}
     Write('Chrom    = ') ;
     for i := 1 to Num do
         begin
              write(Genotype[i]) ;
         end ;
     writeln ;

     Writeln('Chrom No = ',Number) ;
     Writeln('LChrom   = ',LChrom) ;
     Writeln('Fitness  = ',Fitness:5:5) ;
     Writeln('Evaluate = ',Evaluate:5:5) ;
     writeln ;
end ;

Procedure TChromosome.Init ;
var  i,Rand : integer ;
begin
     LChrom   := 30 ;
     Evaluate := 0 ;
     Fitness  := 0 ;

     for i := 1 to LChrom do
     { generate chromosome }
         begin
              Rand := random(100) ;
              if Rand > 50 then Genotype[i] := '1'
              else Genotype[i] := '0' ;
         end ;
end ;

Procedure TChromosome.AddFitness(FValue  : real) ;
begin
     Fitness := FValue ;
end ;

Procedure TChromosome.AddEvaluate(EValue : real) ;
begin
     Evaluate := Evalue ;
end ;

Procedure TChromosome.AddChrom(var Phenome : ChromType) ;
begin
     Genotype := Phenome ;
end ;

Procedure TChromList.DisPlay ;
var i : integer ;
begin
    for i := 1 to NumChrom do
        begin
             ChromList[i].DisPlay ;
        end ;
end ;

Procedure TChromList.Init ;
var i : integer ;
begin
     for i := 1 to NumChrom do
         begin
              ChromList[i].Number := i ;
              ChromList[i].Init ;
         end ;
end ;

Function Rnd(St,Ed : integer) : integer ;
         {random value between St and Ed (Ed>St) }
begin
      Rnd := Random(Ed-St+1)+St ;
end ;

Function Flip(PopFlip : real) : boolean ; {}
var Rand : integer ;
begin
    Rand := Random(100) ;
    if Rand < PopFlip*100 then Flip := true
    else Flip := false ;
end ;

Function FlipBit(Bit : Char) : Char ;
begin
     case Bit of
          '1' : FlipBit := '0' ;
          '0' : FlipBit := '1' ;
     end ;
end ;

Procedure Mutate(var Chrom1,Chrom2 : TChromosome ; Pm : real) ;
var i,Num : integer ;
begin
    Num := Chrom1.LChrom ;
    Chrom2 := Chrom1 ;

    for i := 1 to Num do
        begin
             if Flip(Pm) then Chrom2.GenoType[i]
                              := FlipBit(Chrom1.GeNoType[i]) ;
        end ;
end ;

Procedure Cross(var Par1,Par2,Chld1,Chld2 : TChromosome ;
                Pc : real) ;
var  j,Jcross,Lc : integer ;
begin
     Lc := Par1.LChrom ;
     if Flip(Pc) then
        begin
             Jcross := Rnd(1,Lc-1) ; {random position for crossover}
        end
     else Jcross := Lc ;
     Chld1 := Par1 ;
     Chld2 := Par2 ;

     if Jcross <> Lc then
        for j := Jcross+1 to Lc do
            begin
                Chld1.Genotype[j] := Par2.Genotype[j] ;
                Chld2.Genotype[j] := Par1.Genotype[j] ;
            end ;
end ;

Function Select(var OldPop  : TChromList ; SumFitness : real ;
                    PopSize : integer ) : integer ;
         {Simulate the roulette wheel}
var Rand,PartSum : real ;
    j            : integer ;

begin
     PartSum := 0.0 ;
     j       := 0   ;
     Rand    := Random*SumFitness ;
     Repeat
           j := j+1 ;
           PartSum := PartSum+OldPop.ChromList[j].Fitness ;
     until (PartSum >= Rand) or (j = PopSize) ;
     Select := j ; {Return individual number}
end ;

Procedure TPopulation.Init ;
var  i : integer ;
begin
     randomize ;
     PCross      := 0.35     ;
     PMute       := 0.001    ;
     Generation  := 0        ;
     ChromNumber := 0        ;
     Crosstype   := OnePoint ;
     Selecttype  := Roulette ;
     InvertOptr  := false    ;
     PopSize     := 50 ;
     Population.NumChrom := PopSize ;
     Population.Init ;
     MaxChrom.Init ;
     MinChrom.Init ;
     MinChrom.Fitness := 80 ;
end ;

Procedure TPopulation.DisPlay ;
begin
     writeln('========================================================') ;
     {Population.DisPlay ;}
     Writeln('PCross     = ',PCross:5:5) ;
     Writeln('PMute      = ',PMute:5:5) ;
     Writeln('PopSize    = ',PopSize) ;
     Writeln('Generation = ',Generation) ;
     Writeln('Simfitness = ',SumFitness:5:5) ;
     Writeln('Average    = ',Average:5:5) ;
     writeln ;
     Writeln('Max Chrom is ') ;
     MaxChrom.DisPlay ;
     Writeln('Min Chrom is ') ;
     MinChrom.DisPlay ;
     writeln('========================================================') ;
end ;

Procedure TPopulation.UpdateGen ;
begin
     Generation := Generation+1 ;
end ;

Procedure TPopulation.Selection   ;
var i,j   : integer ;
begin
     Spool.Init ;
     Spool.NumChrom := 50 ;
     for i := 1 to PopSize do
         begin
              j := Select(Population,SumFitness,PopSize) ;
              Spool.ChromList[i] := Population.ChromList[j] ;
         end ;
     Population := Spool ;
end ;

Procedure TPopulation.CrossOver   ;
var  i,Num : integer ;
     Chld1,Chld2,Par1,Par2 : TChromosome ;
begin
     i    := 1 ;
     Num  := Population.NumChrom ;

     Repeat
          Par1 := Population.ChromList[i  ] ;
          Par2 := Population.ChromList[i+1] ;
          Cross(Par1,Par2,Chld1,Chld2,Pcross) ;
          Population.ChromList[i  ] := Chld1 ;
          Population.ChromList[i+1] := Chld2 ;
          i := i+2 ;
     until i > Num ;
end ;

Procedure TPopulation.Mutation    ;
var i,Num : integer ;
    Chrom1,Chrom2 : TChromosome ;
begin
    Num := Population.NumChrom ;
    for i := 1 to Num do
        begin
             Chrom1 := Population.ChromList[i] ;
             Mutate(Chrom1,Chrom2,PMute) ;
             Population.ChromList[i] := Chrom2 ;
        end ;
end ;

Procedure TPopulation.CalSumFitness ;
var i : integer ;
    Temp1,Temp2 : real ;
    Max,Min : real ;
begin
     Temp1 := 0.0 ;
     Temp2 := 0.0 ;
     Max  := MaxChrom.Fitness ;
     Min  := MinChrom.Fitness ;
     for i := 1 to Population.NumChrom do
         begin
             Temp1 := Population.ChromList[i].Fitness ;
             Temp2 := Temp1+Temp2 ;
             if Temp1 > Max then
                begin
                     Max := Temp1 ;
                     MaxChrom := Population.ChromList[i] ;
                     MaxChrom.Gen := Generation ;
                end ;

             if Temp1 < Min then
                begin
                     Min := Temp1 ;
                     MinChrom := Population.ChromList[i] ;
                     MinChrom.Gen := Generation ;
                end ;
         end ;
     SumFitness := Temp2 ;
     Average := SumFitness/(Population.NumChrom+1) ;
end ;

Procedure TPopulation.CalFitNess(ChromNum  : integer) ;
var  Temp : real ;
     Num1,i  : integer ;
begin
     Temp := 0 ;
     Num1  := Population.ChromList[ChromNum].LChrom ;
     for  i := 1 to Num1 do
          begin
               if Population.ChromList[ChromNum].Genotype[i] = '1' then
                  Temp := Temp+1 ;
          end ;
     Population.ChromList[ChromNum].Fitness := Temp ;
     Population.ChromList[ChromNum].GetPhenoType(NumBit) ;
end ;
{
Procedure TPopulation.WriteToFile ;
var fp    : file of TPopulation ;
    Temp  : String[25] ;
    TempGen : TPopulation ;
begin
     TempGen.PCross      := PCross     ;
     TempGen.PMute       := PMute      ;
     TempGen.PopSize     := PopSize    ;
     TempGen.Generation  := Generation ;
     TempGen.ChromNumber := ChromNumber ;
     TempGen.Population  := Population  ;
     TempGen.Crosstype   := Crosstype   ;
     TempGen.Selecttype  := Selecttype  ;
     TempGen.InvertOptr  := InvertOptr  ;
     TempGen.SumFitness  := SumFitness  ;
     TempGen.Average     := Average   ;
     TempGen.MaxChrom    := MaxChrom  ;
     TempGen.MinChrom    := MinChrom  ;
     Str(Generation,Temp) ;
     Temp := 'Gen'+Temp+'.GEN' ;
     assign(fp,Temp) ;
     rewrite(fp) ;
     Write(fp,TempGen) ;
     closefile(fp) ;
end ;
}

{
Procedure TPopulation.CreateNextGen ;
var fp    : file of TPopulation ;
    Temp  : String[25] ;
    TempGen : TPopulation ;
begin
     Selection ;
     CrossOver ;
     Mutation  ;
     UpdateGen ;

     TempGen.PCross      := PCross     ;
     TempGen.PMute       := PMute      ;
     TempGen.PopSize     := PopSize    ;
     TempGen.Generation  := Generation ;
     TempGen.ChromNumber := ChromNumber ;
     TempGen.Population  := Population  ;
     TempGen.Crosstype   := Crosstype   ;
     TempGen.Selecttype  := Selecttype  ;
     TempGen.InvertOptr  := InvertOptr  ;
     TempGen.SumFitness  := SumFitness  ;
     TempGen.Average     := Average   ;
     TempGen.MaxChrom    := MaxChrom  ;
     TempGen.MinChrom    := MinChrom  ;

     Temp := 'CurGen.GEN' ;
     assign(fp,Temp) ;
     rewrite(fp) ;
     Write(fp,TempGen) ;
     closefile(fp) ;
end ;
}
Procedure TPopulation.FindMaxMin ;
begin

end ;

Procedure TPopulation.CalEvaluate(ChromNum : integer) ;
begin
end ;

Procedure TPopulation.SetFitNess(ChromNum  : integer ; fit : real) ;
begin
     Population.ChromList[ChromNum].Fitness := fit ;
end ;

Function  TPopulation.GetFitNess(ChromNum  : integer) : real ;
begin
     GetFitness := Population.ChromList[ChromNum].Fitness ;
end ;

end.